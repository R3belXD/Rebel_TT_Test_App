<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ðŸ‘‘_Test_ðŸ‘‘</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: transparent;
            color: #f0f0f0;
        }

        header {
            background: rgba(35, 39, 43, 0.85);
            padding: 1rem;
            text-align: center;
            font-size: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
        }

        #dataDisplay {
            background: rgba(35, 39, 43, 0.7);
            margin: 1rem;
            padding: 1rem;
            border-radius: 12px;
            min-height: 120px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.10);
            display: none;
        }

        #controls {
            margin: 1rem;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            background: transparent;
        }

        .control-group {
            background: rgba(35, 39, 43, 0.7);
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.10);
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            background: transparent;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        input,
        button {
            margin-bottom: 0.5rem;
            background: rgba(24, 28, 32, 0.5);
            color: #f0f0f0;
            border: 1px solid #444;
            border-radius: 6px;
            padding: 0.4rem 0.7rem;
            font-size: 1rem;
            transition: border 0.2s, box-shadow 0.2s;
        }

        input:focus,
        button:focus {
            outline: none;
            border: 1.5px solid #2d8cf0;
            box-shadow: 0 0 0 2px rgba(45, 140, 240, 0.15);
        }

        button {
            background: rgba(45, 140, 240, 0.5);
            color: #fff;
            border: 1px solid #2d8cf0;
            padding: 0.5rem 1.2rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            letter-spacing: 0.5px;
            box-shadow: 0 1px 4px rgba(45, 140, 240, 0.10);
        }

        button:hover {
            background: rgba(26, 115, 232, 0.7);
        }

        #debugPanel {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            max-height: 20vh;
            overflow-y: auto;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            font-size: 0.9em;
            padding: 0.5em;
            z-index: 10000;
        }

        /* Styles for the XP Earned popup */
        #xpEarnedPopup {
            position: fixed;
            background: rgba(26, 148, 2, 0.9);
            color: #f1efef;
            padding: 8px 12px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1rem;
            opacity: 0;
            pointer-events: none;
            z-index: 99999;
            transition: opacity 0.5s, transform 0.5s;
        }
    </style>
</head>

<body>

    <!-- Main overlay box with gradient border -->
    <div id="walletOverlay" style="
  display:none;
  position:fixed;
  top:10vh;
  left:10vw;
  width:220px;
  min-height:60px;
  max-height:30vh;
  background:rgba(30,30,30,0.92);
  color:#fff;
  z-index:9999;
  overflow:auto;
  padding:1rem 1.2rem;
  font-size:1.2rem;
  border-radius:10px;
  box-shadow:0 4px 24px rgba(0,0,0,0.25);
  border: 4px solid transparent;
  border-image: linear-gradient(to right, cyan, purple) 1;">
    </div>

    <!-- Transparency and options controls -->
    <div id="walletTransparencyControl" style="
  display:none;
  position:fixed;
  top:calc(10vh + 34px);
  left:10vw;
  width:200px;
  z-index:10000;
  padding:0.5rem 0.7rem 0.7rem 0.7rem;
  background:rgba(35,39,43,0.7);
  border-radius:12px;
  box-shadow:0 2px 8px rgba(0,0,0,0.10);
  font-size:1em;
  overflow:hidden;
  border:1px solid black;">
        <label for="walletTransparencySlider" style="color:#fff;font-weight:600;">Transparency</label>
        <input type="range" id="walletTransparencySlider" min="0.2" max="1" step="0.01" value="0.92"
            style="width: calc(100% - 32px); margin: 32 0px;">
        <div id="overlayOptionsPanel" style="margin-top:0.7em;">
            <label style="color:#fff;"><input type="checkbox" id="showWallet" /> Wallet</label>
            <label style="color:#fff;"><input type="checkbox" id="showLevel" /> Level</label>
            <label style="color:#fff;"><input type="checkbox" id="showXPPercent" /> XP %</label>
            <label style="color:#fff;"><input type="checkbox" id="showRawXP" /> Total XP</label>
            <label style="color:#fff;"><input type="checkbox" id="showBonusXP" /> Bonus XP</label>
            <label style="color:#fff;"><input type="checkbox" id="showJob" /> Job</label>
            <label style="color:#fff;"><input type="checkbox" id="showExpEarned" /> EXP Earned</label>
        </div>
    </div>

    <!-- Popup for EXP Earned floating notification -->
    <div id="xpEarnedPopup"></div>

<script>
const jobExpTokenMap = [
  { jobName: "EMS / Paramedic", itemId: "exp_token_a|ems|ems" },
  { jobName: "Firefighter", itemId: "exp_token_a|ems|fire" },
  { jobName: "Farmer", itemId: "exp_token_a|farming|farming" },
  { jobName: "Fisherman", itemId: "exp_token_a|farming|fishing" },
  { jobName: "Miner", itemId: "exp_token_a|farming|mining" },
  { jobName: "Wildlife Hunter", itemId: "exp_token_a|hunting|skill" },
  { jobName: "Cargo Pilot", itemId: "exp_token_a|piloting|cargos" },
  { jobName: "Helicopter Pilot", itemId: "exp_token_a|piloting|heli" },
  { jobName: "Airline Pilot", itemId: "exp_token_a|piloting|piloting" },
  { jobName: "Street Racer", itemId: "exp_token_a|player|racing" },
  { jobName: "Bus Driver", itemId: "exp_token_a|train|bus" },
  { jobName: "Train Conductor", itemId: "exp_token_a|train|train" },
  { jobName: "Garbage Collector", itemId: "exp_token_a|trucking|garbage" },
  { jobName: "Mechanic", itemId: "exp_token_a|trucking|mechanic" },
  { jobName: "PostOP Driver", itemId: "exp_token_a|trucking|postop" },
  { jobName: "Trucker", itemId: "exp_token_a|trucking|trucking" }
];

(function() {
  // Utility functions
  function formatWallet(val) {
    if (val == null || isNaN(val)) return 'N/A';
    const abs = Math.abs(val);
    if (abs >= 1e12) return (val / 1e12).toFixed(2) + 't';
    if (abs >= 1e9) return (val / 1e9).toFixed(2) + 'b';
    if (abs >= 1e6) return (val / 1e6).toFixed(2) + 'm';
    if (abs >= 1e3) return (val / 1e3).toFixed(2) + 'k';
    return val.toLocaleString();
  }
  function formatTruckingXP(xp) {
    if (xp == null || isNaN(xp)) return '0%';
    const percent = Math.max(0, Math.min(100, (xp / 1_000_000) * 100));
    return percent.toFixed(2) + '%';
  }

  let lastXpData = null;
  let lastXpValue = null;
  let lastJobName = null;
  let lastInventoryObj = null;
  let totalXpGained = 0;

  const overlayOptionsDefaults = {
    showWallet: true,
    showXPPercent: true,
    showRawXP: true,
    showBonusXP: true,
    showJob: true,
    showLevel: true,
    showExpEarned: false
  };

  function getOverlayOptions() {
    try {
      return { ...overlayOptionsDefaults, ...JSON.parse(localStorage.getItem('walletOverlay_options')) };
    } catch(e) {
      return {...overlayOptionsDefaults};
    }
  }
  function saveOverlayOptions(opts) {
    try { localStorage.setItem('walletOverlay_options', JSON.stringify(opts)); } catch(e) {}
  }

  function updateOverlayOptionsPanel() {
    const opts = getOverlayOptions();
    document.getElementById('showJob').checked = !!opts.showJob;
    document.getElementById('showWallet').checked = !!opts.showWallet;
    document.getElementById('showXPPercent').checked = !!opts.showXPPercent;
    document.getElementById('showRawXP').checked = !!opts.showRawXP;
    document.getElementById('showBonusXP').checked = !!opts.showBonusXP;
    document.getElementById('showLevel').checked = !!opts.showLevel;
    document.getElementById('showExpEarned').checked = !!opts.showExpEarned;
  }

  function listenOverlayOptionsPanel() {
    ['showWallet', 'showXPPercent', 'showRawXP', 'showBonusXP', 'showJob', 'showLevel', 'showExpEarned'].forEach(id => {
      document.getElementById(id).addEventListener('change', () => {
        const opts = getOverlayOptions();
        opts[id] = document.getElementById(id).checked;
        saveOverlayOptions(opts);
        updateWalletOverlayFromDataset();
      });
    });
  }

  function updateWalletOverlayFromDataset() {
    const overlay = document.getElementById('walletOverlay');
    const wallet = overlay.dataset.wallet ? Number(overlay.dataset.wallet) : null;
    const truckingXP = overlay.dataset.truckingXp ? Number(overlay.dataset.truckingXp) : null;
    const bonusXP = overlay.dataset.bonusXp ? Number(overlay.dataset.bonusXp) : null;
    const jobName = overlay.dataset.jobName || '';
    updateWalletOverlay(wallet, truckingXP, bonusXP, jobName);
  }

  function updateWalletOverlay(wallet, truckingXP, bonusXP, jobName) {
    const overlay = document.getElementById('walletOverlay');

    try {
      if (wallet != null && !isNaN(wallet)) localStorage.setItem('walletOverlay_wallet', wallet);
      if (truckingXP != null && !isNaN(truckingXP)) localStorage.setItem('walletOverlay_truckingXp', truckingXP);
      if (bonusXP != null && !isNaN(bonusXP)) localStorage.setItem('walletOverlay_bonusXp', bonusXP);
      if (jobName) localStorage.setItem('walletOverlay_jobName', jobName);
    } catch(e){}

    // Map to get the correct XP field based on job name
    const jobExpFieldMap = {
      "Trucker": "exp_trucking_trucking",
      "Mechanic": "exp_trucking_mechanic",
      "Garbage Collector": "exp_trucking_garbage",
      "PostOP Driver": "exp_trucking_postop",
      "Airline Pilot": "exp_piloting_piloting",
      "Helicopter Pilot": "exp_piloting_heli",
      "Cargo Pilot": "exp_piloting_cargos",
      "Bus Driver": "exp_train_bus",
      "Train Conductor": "exp_train_train",
      "EMS / Paramedic": "exp_ems_ems",
      "Firefighter": "exp_ems_fire",
      "Businesses": "exp_business_business",
      "Street Racer": "exp_player_racing",
      "Farmer": "exp_farming_farming",
      "Fisherman": "exp_farming_fishing",
      "Miner": "exp_farming_mining",
      "Wildlife Hunter": "exp_hunting_skill"
    };

    // Determine XP value
    let xpVal = null;
    if (jobName && typeof jobExpFieldMap[jobName] === "string" && lastXpData) {
      const xpField = jobExpFieldMap[jobName];
      if (typeof lastXpData[xpField] !== "undefined") {
        xpVal = Number(lastXpData[xpField]);
      }
    }
    if (xpVal == null && typeof truckingXP !== "undefined" && truckingXP !== null) {
      xpVal = Number(truckingXP);
    }
    const xpPercent = (xpVal != null && !isNaN(xpVal)) ? (Math.max(0, Math.min(100, (xpVal / 1_000_000) * 100))) : 0;

    // Show EXP gained popup if needed
    const opts = getOverlayOptions();
    if (opts.showExpEarned) {
      if (xpVal != null && typeof lastXpValue === 'number') {
        const gained = xpVal - lastXpValue;
        if (gained > 0) {
          totalXpGained += gained;
          showXpPopup(gained);
        }
      }
      lastXpValue = xpVal;
    }

    // Build display fields
    let fields = [];
    if (opts.showJob && jobName)
      fields.push(`<b>Job:</b> <span style='font-size:1.1em;color:#ffa07a;'>${jobName}</span>`);

    if (opts.showLevel) {
      let level = (xpVal != null && !isNaN(xpVal))
        ? Math.floor((Math.sqrt(1 + 8 * xpVal / 5) - 1) / 2)
        : null;
      fields.push(`<b>Level:</b> <span style='font-size:1.1em;color:#b0e0e6;'>${level != null && level >= 0 ? level : 'N/A'}</span>`);
    }

    if (opts.showBonusXP)
      fields.push(`<b>Bonus XP Left:</b> <span style='font-size:1.1em;color:#ffd700;'>${bonusXP != null && !isNaN(bonusXP) ? Number(bonusXP).toLocaleString() : 'N/A'}</span>`);

    if (opts.showRawXP)
      fields.push(`<b>Total XP:</b> <span style='font-size:1.1em;color:#ffb347;'>${xpVal != null && !isNaN(xpVal) ? Math.floor(xpVal).toLocaleString() : 'N/A'}</span>`);

    if (opts.showXPPercent)
      fields.push(`<b>% to 1m XP:</b> <span style='font-size:1.1em;color:#8cf0ff;'>${xpPercent.toFixed(2)}%</span>`);

    if (opts.showWallet)
      fields.push(`<b>Wallet:</b> <span style='font-size:1.3em;color:#7cff7c;'>${formatWallet(wallet)}</span>`);

    // Update overlay
    overlay.innerHTML = fields.join('<br>');
    overlay.style.display = '';
    // setOverlayAlpha(slider.value); // you need to implement this
    // update dataset attributes
    overlay.dataset.wallet = wallet != null ? wallet : '';
    overlay.dataset.truckingXp = truckingXP != null ? truckingXP : '';
    overlay.dataset.bonusXp = bonusXP != null ? bonusXP : '';
    overlay.dataset.jobName = jobName || '';
  }

  // Your other functions: makeDraggable, restoreOverlayAlpha, showTransparencyControl, hideTransparencyControl, showXpPopup, etc.
  // Make sure they are implemented correctly and not duplicated.

  // The key point: Remove all duplicate extractOverlayData and ensure only one version exists.
})();
</script>
</body>
</html>
