<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>üëë_ùï≠ùñéùñôùñç_üëë</title>
<style>
  body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: transparent; color: #f0f0f0; }
  header { background: rgba(35,39,43,0.85); padding: 1rem; text-align: center; font-size: 1.5rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.12); }
  #dataDisplay { background: rgba(35,39,43,0.7); margin: 1rem; padding: 1rem; border-radius: 12px; min-height: 120px; box-shadow: 0 2px 8px rgba(0,0,0,0.10); display:none; }
  #controls { margin: 1rem; display: flex; flex-wrap: wrap; gap: 1rem; background: transparent; }
  .control-group { background: rgba(35,39,43,0.7); padding: 1rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.10); }
  label { display: block; margin-bottom: 0.5rem; background: transparent; font-weight: 600; letter-spacing: 0.5px; }
  input, button { margin-bottom: 0.5rem; background: rgba(24,28,32,0.5); color: #f0f0f0; border: 1px solid #444; border-radius: 6px; padding: 0.4rem 0.7rem; font-size: 1rem; transition: border 0.2s, box-shadow 0.2s; }
  input:focus, button:focus { outline: none; border: 1.5px solid #2d8cf0; box-shadow: 0 0 0 2px rgba(45,140,240,0.15); }
  button { background: rgba(45,140,240,0.5); color: #fff; border: 1px solid #2d8cf0; padding: 0.5rem 1.2rem; border-radius: 6px; cursor: pointer; font-weight: 600; letter-spacing: 0.5px; box-shadow: 0 1px 4px rgba(45,140,240,0.10); }
  button:hover { background: rgba(26,115,232,0.7); }
  #debugPanel {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    max-height: 20vh;
    overflow-y: auto;
    background-color: rgba(0, 0, 0, 0.8);
    color: white;
    font-size: 0.9em;
    padding: 0.5em;
    z-index: 10000;
  }
  /* XP Popup styling */
  #xpEarnedPopup {
    position: fixed;
    background: rgba(26, 148, 2, 0.9);
    color: #f1efef;
    padding: 8px 12px;
    border-radius: 8px;
    font-weight: bold;
    font-size: 1rem;
    opacity: 0;
    pointer-events: none;
    z-index: 99999;
    transition: opacity 0.5s, transform 0.5s;
  }
</style>
</head>
<body>

<!-- Main overlay -->
<div id="walletOverlay" style="
  display:none;
  position:fixed;
  top:10vh;
  left:10vw;
  width:220px;
  min-height:60px;
  max-height:30vh;
  background:rgba(30,30,30,0.92);
  color:#fff;
  z-index:9999;
  overflow:auto;
  padding:1rem 1.2rem;
  font-size:1.2rem;
  border-radius:10px;
  box-shadow:0 4px 24px rgba(0,0,0,0.25);
  border: 4px solid transparent;
  border-image: linear-gradient(to right, cyan, purple) 1;">
</div>

<!-- Controls for transparency and options -->
<div id="walletTransparencyControl" style="
  display:none;
  position:fixed;
  top:calc(10vh + 34px);
  left:10vw;
  width:200px;
  z-index:10000;
  padding:0.5rem 0.7rem 0.7rem 0.7rem;
  background:rgba(35,39,43,0.7);
  border-radius:12px;
  box-shadow:0 2px 8px rgba(0,0,0,0.10);
  font-size:1em;
  overflow:hidden;
  border:1px solid black;">
    <label for="walletTransparencySlider" style="color:#fff;font-weight:600;">Transparency</label>
    <input type="range" id="walletTransparencySlider" min="0.2" max="1" step="0.01" value="0.92" style="width: calc(100% - 32px); margin: 32 0px;">
    <div id="overlayOptionsPanel" style="margin-top:0.7em;">
        <label style="color:#fff;"><input type="checkbox" id="showWallet"/> Wallet</label>
        <label style="color:#fff;"><input type="checkbox" id="showLevel"/> Level</label>
        <label style="color:#fff;"><input type="checkbox" id="showXPPercent"/> XP %</label>
        <label style="color:#fff;"><input type="checkbox" id="showRawXP"/> Total XP</label>
        <label style="color:#fff;"><input type="checkbox" id="showBonusXP"/> Bonus XP</label>
        <label style="color:#fff;"><input type="checkbox" id="showJob"/> Job</label>
        <label style="color:#fff;"><input type="checkbox" id="showExpEarned"/> EXP Earned</label>
    </div>
</div>

<!-- XP popup -->
<div id="xpEarnedPopup"></div>

<script>
const jobExpTokenMap = [
  { jobName: "EMS / Paramedic", itemId: "exp_token_a|ems|ems" },
  { jobName: "Firefighter", itemId: "exp_token_a|ems|fire" },
  { jobName: "Farmer", itemId: "exp_token_a|farming|farming" },
  { jobName: "Fisherman", itemId: "exp_token_a|farming|fishing" },
  { jobName: "Miner", itemId: "exp_token_a|farming|mining" },
  { jobName: "Wildlife Hunter", itemId: "exp_token_a|hunting|skill" },
  { jobName: "Cargo Pilot", itemId: "exp_token_a|piloting|cargos" },
  { jobName: "Helicopter Pilot", itemId: "exp_token_a|piloting|heli" },
  { jobName: "Airline Pilot", itemId: "exp_token_a|piloting|piloting" },
  { jobName: "Street Racer", itemId: "exp_token_a|player|racing" },
  { jobName: "Bus Driver", itemId: "exp_token_a|train|bus" },
  { jobName: "Train Conductor", itemId: "exp_token_a|train|train" },
  { jobName: "Garbage Collector", itemId: "exp_token_a|trucking|garbage" },
  { jobName: "Mechanic", itemId: "exp_token_a|trucking|mechanic" },
  { jobName: "PostOP Driver", itemId: "exp_token_a|trucking|postop" },
  { jobName: "Trucker", itemId: "exp_token_a|trucking|trucking" }
];

(function() {
  // Declare overlay once
  const overlay = document.getElementById('walletOverlay');

  // Utility functions
  function formatWallet(val) {
    if (val == null || isNaN(val)) return 'N/A';
    const abs = Math.abs(val);
    if (abs >= 1e12) return (val/1e12).toFixed(2) + 't';
    if (abs >= 1e9) return (val/1e9).toFixed(2) + 'b';
    if (abs >= 1e6) return (val/1e6).toFixed(2) + 'm';
    if (abs >= 1e3) return (val/1e3).toFixed(2) + 'k';
    return val.toLocaleString();
  }
  function formatTruckingXP(xp) {
    if (xp == null || isNaN(xp)) return '0%';
    const percent = Math.max(0, Math.min(100, (xp / 1_000_000) * 100));
    return percent.toFixed(2) + '%';
  }

  let lastXpData = null;
  let lastXpValue = null;
  let totalXpGained = 0;
  let currentBonusXP = 0; // Store latest bonus

  // Load options defaults
  const overlayOptionsDefaults = {
    showWallet: true,
    showXPPercent: true,
    showRawXP: true,
    showBonusXP: true,
    showJob: true,
    showLevel: true,
    showExpEarned: false
  };

  function getOverlayOptions() {
    try {
      return { ...overlayOptionsDefaults, ...JSON.parse(localStorage.getItem('walletOverlay_options')) };
    } catch(e) { return {...overlayOptionsDefaults}; }
  }

  function saveOverlayOptions(opts) {
    try { localStorage.setItem('walletOverlay_options', JSON.stringify(opts)); } catch(e) {}
  }

  function updateOverlayOptionsPanel() {
    const opts = getOverlayOptions();
    document.getElementById('showWallet').checked = !!opts.showWallet;
    document.getElementById('showXPPercent').checked = !!opts.showXPPercent;
    document.getElementById('showRawXP').checked = !!opts.showRawXP;
    document.getElementById('showBonusXP').checked = !!opts.showBonusXP;
    document.getElementById('showJob').checked = !!opts.showJob;
    document.getElementById('showLevel').checked = !!opts.showLevel;
    document.getElementById('showExpEarned').checked = !!opts.showExpEarned;
  }

  function listenOverlayOptionsPanel() {
    ['showWallet','showXPPercent','showRawXP','showBonusXP','showJob','showLevel','showExpEarned'].forEach(id => {
      document.getElementById(id).addEventListener('change', () => {
        const opts = getOverlayOptions();
        opts[id] = document.getElementById(id).checked;
        saveOverlayOptions(opts);
        updateWalletOverlayFromDataset();
      });
    });
  }

  function updateWalletOverlayFromDataset() {
    const overlay = document.getElementById('walletOverlay');
    let wallet = overlay.dataset.wallet ? Number(overlay.dataset.wallet) : null;
    let truckingXP = overlay.dataset.truckingXp ? Number(overlay.dataset.truckingXp) : null;
    let bonusXP = overlay.dataset.bonusXp ? Number(overlay.dataset.bonusXp) : null;
    let jobName = overlay.dataset.jobName || '';
    updateWalletOverlay(wallet, truckingXP, bonusXP, jobName);
  }

  // Main overlay update function
  function updateWalletOverlay(wallet, truckingXP, bonusXP, jobName) {
    // Save to local storage
    try {
      if (wallet != null && !isNaN(wallet)) localStorage.setItem('walletOverlay_wallet', wallet);
      if (truckingXP != null && !isNaN(truckingXP)) localStorage.setItem('walletOverlay_truckingXp', truckingXP);
      if (bonusXP != null && !isNaN(bonusXP)) localStorage.setItem('walletOverlay_bonusXp', bonusXP);
      if (jobName) localStorage.setItem('walletOverlay_jobName', jobName);
    } catch(e){}

    // Map for XP fields
    const jobExpFieldMap = {
      "Trucker": "exp_trucking_trucking",
      "Mechanic": "exp_trucking_mechanic",
      "Garbage Collector": "exp_trucking_garbage",
      "PostOP Driver": "exp_trucking_postop",
      "Airline Pilot": "exp_piloting_piloting",
      "Helicopter Pilot": "exp_piloting_heli",
      "Cargo Pilot": "exp_piloting_cargos",
      "Bus Driver": "exp_train_bus",
      "Train Conductor": "exp_train_train",
      "EMS / Paramedic": "exp_ems_ems",
      "Firefighter": "exp_ems_fire",
      "Businesses": "exp_business_business",
      "Street Racer": "exp_player_racing",
      "Farmer": "exp_farming_farming",
      "Fisherman": "exp_farming_fishing",
      "Miner": "exp_farming_mining",
      "Wildlife Hunter": "exp_hunting_skill"
    };

    let xpVal = null;
    if (jobName && typeof jobExpFieldMap[jobName] === "string" && lastXpData) {
      const xpField = jobExpFieldMap[jobName];
      if (typeof lastXpData[xpField] !== "undefined") {
        xpVal = Number(lastXpData[xpField]);
      }
    }
    if (xpVal == null && typeof truckingXP !== "undefined" && truckingXP !== null) {
      xpVal = Number(truckingXP);
    }
    const xpPercent = (xpVal != null && !isNaN(xpVal))
      ? Math.max(0, Math.min(100, (xpVal / 1_000_000) * 100))
      : 0;

    // Update latest bonus XP
    currentBonusXP = bonusXP;

    // Build overlay display
    const opts = getOverlayOptions();
    let fields = [];

    if (opts.showJob && jobName)
      fields.push(`<b>Job:</b> <span style='font-size:1.1em;color:#ffa07a;'>${jobName}</span>`);

    if (opts.showLevel) {
      let level = (xpVal != null && !isNaN(xpVal))
        ? Math.floor((Math.sqrt(1 + 8 * xpVal / 5) - 1) / 2)
        : null;
      fields.push(`<b>Level:</b> <span style='font-size:1.1em;color:#b0e0e6;'>${level != null && level >= 0 ? level : 'N/A'}</span>`);
    }

    if (opts.showBonusXP)
      fields.push(`<b>Bonus XP Left:</b> <span style='font-size:1.1em;color:#ffd700;'>${Number(bonusXP).toLocaleString()}</span>`);

    if (opts.showRawXP)
      fields.push(`<b>Total XP:</b> <span style='font-size:1.1em;color:#ffb347;'>${xpVal != null && !isNaN(xpVal) ? Math.floor(xpVal).toLocaleString() : 'N/A'}</span>`);

    if (opts.showXPPercent)
      fields.push(`<b>% to 1M XP:</b> <span style='font-size:1.1em;color:#8cf0ff;'>${xpPercent.toFixed(2)}%</span>`);

    if (opts.showWallet)
      fields.push(`<b>Wallet:</b> <span style='font-size:1.3em;color:#7cff7c;'>${formatWallet(wallet)}</span>`);

    // Set inner HTML
    overlay.innerHTML = fields.join('<br>');
    overlay.style.display = 'block';

    // Save to dataset
    overlay.dataset.wallet = wallet != null ? wallet : '';
    overlay.dataset.truckingXp = truckingXP != null ? truckingXP : '';
    overlay.dataset.bonusXp = bonusXP != null ? bonusXP : '';
    overlay.dataset.jobName = jobName || '';

    // Set alpha
    setOverlayAlpha(slider.value);
  }

  // Data extraction function
  function extractOverlayData(event) {
    let wallet = null, truckingXP = null, bonusXP = null, jobName = null;
    if (event.data && event.data.type === 'data' && event.data.fromTycoonScript && event.data.data) {
      const data = event.data.data;
      for (const k of [
        "exp_trucking_mechanic","exp_piloting_cargos","exp_farming_mining","exp_business_business",
        "exp_trucking_garbage","exp_trucking_trucking","exp_ems_ems","exp_player_racing",
        "exp_train_bus","exp_ems_fire","exp_train_train","exp_trucking_postop","exp_piloting_heli",
        "exp_business_faction","exp_farming_farming","exp_farming_fishing","exp_hunting_skill",
        "exp_piloting_piloting"
      ]) {
        if (typeof data[k] !== "undefined") {
          lastXpData = data;
          break;
        }
      }
      wallet = data.wallet ?? null;
      truckingXP = data.exp_trucking_trucking ?? data.truckingXP ?? null;

      if (typeof data.job_name !== "undefined" || typeof data.job_title !== "undefined") {
        jobName = data.job_name ?? data.job_title ?? null;
        if (jobName !== lastJobName) lastJobName = jobName;
      } else {
        jobName = lastJobName;
      }

      let inventoryObj = null;
      if (data.inventory) {
        if (typeof data.inventory === 'string') {
          try { inventoryObj = JSON.parse(data.inventory); } catch (e) { inventoryObj = null; }
        } else if (typeof data.inventory === 'object') {
          inventoryObj = data.inventory;
        }
        if (inventoryObj) lastInventoryObj = inventoryObj;
      }
      if (!inventoryObj && lastInventoryObj) {
        inventoryObj = lastInventoryObj;
      }

      if (inventoryObj) {
        let found = false;
        let lastBonusXP = null;
        if (jobName) {
          const jobEntry = jobExpTokenMap.find(entry => entry.jobName.toLowerCase() === jobName.toLowerCase());
          if (jobEntry) {
            const itemId = jobEntry.itemId;
            for (const key in inventoryObj) {
              if (key.toLowerCase() === itemId.toLowerCase()) {
                const item = inventoryObj[key];
                if (item && typeof item.amount === 'number') {
                  lastBonusXP = item.amount;
                  if (bonusXP !== lastBonusXP) bonusXP = item.amount;
                  break;
                }
              }
            }
          }
        }
        if (!found && !jobName) {
          for (const key in inventoryObj) {
            if (/^exp_token_a\|/i.test(key)) {
              const item = inventoryObj[key];
              if (item && typeof item.amount === 'number') {
                bonusXP = item.amount;
                break;
              }
            }
          }
        }
      }
    }
    return { wallet, truckingXP, bonusXP, jobName };
  }

  // Draggable function
  function makeDraggable(element) {
    let isDragging = false, offsetX = 0, offsetY = 0;
    element.addEventListener('mousedown', (e) => {
      isDragging = true;
      offsetX = e.clientX - element.offsetLeft;
      offsetY = e.clientY - element.offsetTop;
      element.style.cursor = 'grabbing';
    });
    document.addEventListener('mousemove', (e) => {
      if (isDragging) {
        element.style.left = (e.clientX - offsetX) + 'px';
        element.style.top = (e.clientY - offsetY) + 'px';
        // move overlay options panel accordingly
        transparencyControl.style.left = element.style.left;
        transparencyControl.style.top = (parseInt(element.style.top) + element.offsetHeight + 4) + 'px';
      }
    });
    document.addEventListener('mouseup', () => {
      if (isDragging) {
        saveOverlayPosition('walletOverlay', element.offsetLeft, element.offsetTop);
        isDragging = false;
        element.style.cursor = 'move';
      }
    });
  }

  function saveOverlayPosition(id, left, top) {
    try { localStorage.setItem('overlayPos_' + id, JSON.stringify({ left, top })); } catch(e) {}
  }

  function restoreOverlayPosition(id, el, defaultLeft, defaultTop) {
    try {
      const pos = JSON.parse(localStorage.getItem('overlayPos_' + id));
      if (pos && typeof pos.left === 'number' && typeof pos.top === 'number') {
        el.style.left = pos.left + 'px';
        el.style.top = pos.top + 'px';
      } else {
        el.style.left = defaultLeft;
        el.style.top = defaultTop;
      }
    } catch(e) {
      el.style.left = defaultLeft;
      el.style.top = defaultTop;
    }
  }

  // On DOM load
  window.addEventListener('DOMContentLoaded', () => {
    // Make overlay draggable
    makeDraggable(overlay);
    // Restore position
    restoreOverlayPosition('walletOverlay', overlay, '10vw', '10vh');

    // Load previous data
    let wallet = localStorage.getItem('walletOverlay_wallet');
    let truckingXP = localStorage.getItem('walletOverlay_truckingXp');
    let bonusXP = localStorage.getItem('walletOverlay_bonusXp');

    wallet = wallet !== null ? Number(wallet) : null;
    truckingXP = truckingXP !== null ? Number(truckingXP) : null;
    bonusXP = bonusXP !== null ? Number(bonusXP) : null;

    // Set dataset for future updates
    overlay.dataset.wallet = wallet != null ? wallet : '';
    overlay.dataset.truckingXp = truckingXP != null ? truckingXP : '';
    overlay.dataset.bonusXp = bonusXP != null ? bonusXP : '';

    // Show overlay if data exists
    if (wallet != null || truckingXP != null || bonusXP != null) {
      updateWalletOverlay(wallet, truckingXP, bonusXP);
      overlay.style.display = '';
    }

    // Initialize options panel
    updateOverlayOptionsPanel();
    listenOverlayOptionsPanel();

    // Show overlay immediately for testing
    overlay.style.display = '';

    // Start auto-refresh (simulate data update every 5 sec for demo)
    setInterval(() => {
      if (lastXpData && lastXpValue !== null && lastJobName !== null) {
        const overlayEl = document.getElementById('walletOverlay');
        let w = overlayEl.dataset.wallet ? Number(overlayEl.dataset.wallet) : null;
        let t = overlayEl.dataset.truckingXp ? Number(overlayEl.dataset.truckingXp) : null;
        let b = overlayEl.dataset.bonusXp ? Number(overlayEl.dataset.bonusXp) : null;
        updateWalletOverlay(w, t, b, lastJobName);
      }
    }, 5000);
  });

  // Global variables
  let lastXpData = null;
  let lastXpValue = null;
  let lastJobName = null;
  let currentBonusXP = 0; // store latest bonus XP

  // Message event to receive data
  window.addEventListener('message', (event) => {
    // Focus detection code omitted for brevity
    // Extract data
    const { wallet, truckingXP, bonusXP, jobName } = extractOverlayData(event);
    // Save latest bonus XP
    currentBonusXP = bonusXP;
    // Determine if need to update overlay
    const overlayEl = document.getElementById('walletOverlay');
    const prevWallet = overlayEl.dataset.wallet ? Number(overlayEl.dataset.wallet) : null;
    const prevTrucking = overlayEl.dataset.truckingXp ? Number(overlayEl.dataset.truckingXp) : null;
    const prevBonus = overlayEl.dataset.bonusXp ? Number(overlayEl.dataset.bonusXp) : null;
    const prevJob = overlayEl.dataset.jobName || '';

    const updateNeeded =
      wallet !== prevWallet ||
      truckingXP !== prevTrucking ||
      bonusXP !== prevBonus ||
      jobName !== prevJob;

    if (wallet != null || truckingXP != null || bonusXP != null || jobName) {
      if (updateNeeded) {
        updateWalletOverlay(wallet, truckingXP, bonusXP, jobName);
        overlayEl.dataset.wallet = wallet != null ? wallet : '';
        overlayEl.dataset.truckingXp = truckingXP != null ? truckingXP : '';
        overlayEl.dataset.bonusXp = bonusXP != null ? bonusXP : '';
        overlayEl.dataset.jobName = jobName;
        overlayEl.style.display = '';
      }
    }
  });

  // Your helper functions:
  function extractOverlayData(event) {
    let wallet = null, truckingXP = null, bonusXP = null, jobName = null;
    if (event.data?.type === 'data' && event.data.fromTycoonScript && event.data.data) {
      const data = event.data.data;
      for (const k of [
        "exp_trucking_mechanic","exp_piloting_cargos","exp_farming_mining",
        "exp_business_business","exp_trucking_garbage","exp_trucking_trucking",
        "exp_ems_ems","exp_player_racing","exp_train_bus","exp_ems_fire",
        "exp_train_train","exp_trucking_postop","exp_piloting_heli",
        "exp_business_faction","exp_farming_farming","exp_farming_fishing",
        "exp_hunting_skill","exp_piloting_piloting"
      ]) {
        if (typeof data[k] !== "undefined") {
          lastXpData = data;
          break;
        }
      }
      wallet = data.wallet ?? null;
      truckingXP = data.exp_trucking_trucking ?? data.truckingXP ?? null;
      if (typeof data.job_name !== "undefined" || typeof data.job_title !== "undefined") {
        jobName = data.job_name ?? data.job_title ?? null;
        if (jobName !== lastJobName) lastJobName = jobName;
      } else {
        jobName = lastJobName;
      }
      let inventoryObj = null;
      if (data.inventory) {
        if (typeof data.inventory === 'string') {
          try { inventoryObj = JSON.parse(data.inventory); } catch(e) { inventoryObj = null; }
        } else if (typeof data.inventory === 'object') {
          inventoryObj = data.inventory;
        }
        if (inventoryObj) lastInventoryObj = inventoryObj;
      }
      if (!inventoryObj && lastInventoryObj) {
        inventoryObj = lastInventoryObj;
      }
      if (inventoryObj) {
        for (const key in inventoryObj) {
          if (typeof inventoryObj[key].amount === 'number') {
            if (
              (jobName && key.toLowerCase() === (jobExpTokenMap.find(e => e.jobName === jobName)?.itemId ?? '').toLowerCase()) ||
              (/^exp_token_a\|/i.test(key))
            ) {
              bonusXP = inventoryObj[key].amount;
              break;
            }
          }
        }
      }
    }
    return { wallet, truckingXP, bonusXP, jobName };
  }

  // Make draggable
  function makeDraggable(el) {
    let isDragging = false, offsetX=0, offsetY=0;
    el.addEventListener('mousedown', (e) => {
      isDragging = true;
      offsetX = e.clientX - el.offsetLeft;
      offsetY = e.clientY - el.offsetTop;
      el.style.cursor = 'grabbing';
    });
    document.addEventListener('mousemove', (e) => {
      if (isDragging) {
        el.style.left = (e.clientX - offsetX) + 'px';
        el.style.top = (e.clientY - offsetY) + 'px';
        transparencyControl.style.left = el.style.left;
        transparencyControl.style.top = (parseInt(el.style.top) + el.offsetHeight + 4) + 'px';
      }
    });
    document.addEventListener('mouseup', () => {
      if (isDragging) {
        saveOverlayPosition('walletOverlay', el.offsetLeft, el.offsetTop);
        isDragging=false;
        el.style.cursor='move';
      }
    });
  }

  function saveOverlayPosition(id,left,top) {
    try { localStorage.setItem('overlayPos_' + id, JSON.stringify({left,top})); } catch(e) {}
  }

  function restoreOverlayPosition(id, el, defLeft, defTop) {
    try {
      const pos = JSON.parse(localStorage.getItem('overlayPos_' + id));
      if (pos && typeof pos.left==='number' && typeof pos.top==='number') {
        el.style.left = pos.left + 'px';
        el.style.top = pos.top + 'px';
      } else {
        el.style.left=defLeft; el.style.top=defTop;
      }
    } catch(e) {
      el.style.left=defLeft; el.style.top=defTop;
    }
  }

  // On DOM load
  window.addEventListener('DOMContentLoaded', () => {
    makeDraggable(overlay);
    restoreOverlayPosition('walletOverlay', overlay, '10vw', '10vh');

    // Load previous data
    let w = localStorage.getItem('walletOverlay_wallet');
    let t = localStorage.getItem('walletOverlay_truckingXp');
    let b = localStorage.getItem('walletOverlay_bonusXp');

    w = w!==null?Number(w):null;
    t = t!==null?Number(t):null;
    b = b!==null?Number(b):null;

    overlay.dataset.wallet = w!==null?w:'';
    overlay.dataset.truckingXp = t!==null?t:'';
    overlay.dataset.bonusXp = b!==null?b:'';

    if (w!==null || t!==null || b!==null) {
      updateWalletOverlay(w, t, b);
      overlay.style.display='';
    }

    // For demo, show overlay immediately
    overlay.style.display='';

    // Start auto-refresh simulation
    setInterval(() => {
      if (lastXpData && lastXpValue!==null && lastJobName!==null) {
        const el = document.getElementById('walletOverlay');
        let w = el.dataset.wallet?Number(el.dataset.wallet):null;
        let t = el.dataset.truckingXp?Number(el.dataset.truckingXp):null;
        let b = el.dataset.bonusXp?Number(el.dataset.bonusXp):null;
        updateWalletOverlay(w, t, b, lastJobName);
      }
    }, 5000);
  });

  // Global vars
  let lastXpData=null, lastXpValue=null, lastJobName=null, currentBonusXP=0;

  // Message event
  window.addEventListener('message', (event) => {
    // Focus code omitted for brevity
    const { wallet, truckingXP, bonusXP, jobName } = extractOverlayData(event);
    currentBonusXP = bonusXP; // update latest bonus
    const el = document.getElementById('walletOverlay');
    const prevW = el.dataset.wallet?Number(el.dataset.wallet):null;
    const prevT = el.dataset.truckingXp?Number(el.dataset.truckingXp):null;
    const prevB = el.dataset.bonusXp?Number(el.dataset.bonusXp):null;
    const prevJ = el.dataset.jobName||'';

    const needUpdate = 
      wallet!==prevW || truckingXP!==prevT || bonusXP!==prevB || jobName!==prevJ;

    if (wallet!==null || truckingXP!==null || bonusXP!==null || jobName) {
      if (needUpdate) {
        updateWalletOverlay(wallet, truckingXP, bonusXP, jobName);
        el.dataset.wallet=wallet!==null?wallet:'';
        el.dataset.truckingXp=truckingXP!==null?truckingXP:'';
        el.dataset.bonusXp=bonusXP!==null?bonusXP:'';
        el.dataset.jobName=jobName;
        el.style.display='';
      }
    }
  });

  // Your helper functions
  function updateWalletOverlay(wallet, truckingXP, bonusXP, jobName) {
    // Save to local storage
    try {
      if (wallet!==null && !isNaN(wallet)) localStorage.setItem('walletOverlay_wallet',wallet);
      if (truckingXP!==null && !isNaN(truckingXP)) localStorage.setItem('walletOverlay_truckingXp',truckingXP);
      if (bonusXP!==null && !isNaN(bonusXP)) localStorage.setItem('walletOverlay_bonusXp',bonusXP);
    } catch(e){}
    // Map for XP fields
    const map = {
      "Trucker": "exp_trucking_trucking",
      "Mechanic": "exp_trucking_mechanic",
      "Garbage Collector": "exp_trucking_garbage",
      "PostOP Driver": "exp_trucking_postop",
      "Airline Pilot": "exp_piloting_piloting",
      "Helicopter Pilot": "exp_piloting_heli",
      "Cargo Pilot": "exp_piloting_cargos",
      "Bus Driver": "exp_train_bus",
      "Train Conductor": "exp_train_train",
      "EMS / Paramedic": "exp_ems_ems",
      "Firefighter": "exp_ems_fire",
      "Businesses": "exp_business_business",
      "Street Racer": "exp_player_racing",
      "Farmer": "exp_farming_farming",
      "Fisherman": "exp_farming_fishing",
      "Miner": "exp_farming_mining",
      "Wildlife Hunter": "exp_hunting_skill"
    };
    let xpVal = null;
    if (jobName && typeof map[jobName]==='string' && lastXpData) {
      const k = map[jobName];
      if (typeof lastXpData[k]!=='undefined') xpVal=Number(lastXpData[k]);
    }
    if (xpVal==null && typeof truckingXP!=='undefined' && truckingXP!==null) xpVal=Number(truckingXP);
    const xpPercent = (xpVal!=null && !isNaN(xpVal)) ? Math.max(0, Math.min(100, (xpVal/1e6)*100)) : 0;

    // Save latest bonus XP
    currentBonusXP=bonusXP;

    // Build overlay fields
    const opts = getOverlayOptions();
    let fields=[];
    if (opts.showJob && jobName)
      fields.push(`<b>Job:</b> <span style='font-size:1.1em;color:#ffa07a;'>${jobName}</span>`);
    if (opts.showLevel) {
      let level = (xpVal != null && !isNaN(xpVal))
        ? Math.floor((Math.sqrt(1+8*xpVal/5)-1)/2)
        : null;
      fields.push(`<b>Level:</b> <span style='font-size:1.1em;color:#b0e0e6;'>${level!==null && level>=0 ? level:'N/A'}</span>`);
    }
    if (opts.showBonusXP)
      fields.push(`<b>Bonus XP Left:</b> <span style='font-size:1.1em;color:#ffd700;'>${Number(bonusXP).toLocaleString()}</span>`);
    if (opts.showRawXP)
      fields.push(`<b>Total XP:</b> <span style='font-size:1.1em;color:#ffb347;'>${xpVal!=null && !isNaN(xpVal) ? Math.floor(xpVal).toLocaleString() :'N/A'}</span>`);
    if (opts.showXPPercent)
      fields.push(`<b>% to 1M XP:</b> <span style='font-size:1.1em;color:#8cf0ff;'>${xpPercent.toFixed(2)}%</span>`);
    if (opts.showWallet)
      fields.push(`<b>Wallet:</b> <span style='font-size:1.3em;color:#7cff7c;'>${formatWallet(wallet)}</span>`);

    // Update overlay
    document.getElementById('walletOverlay').innerHTML=fields.join('<br>');
    document.getElementById('walletOverlay').style.display='';

    // Save dataset
    const el = document.getElementById('walletOverlay');
    el.dataset.wallet=wallet!==null?wallet:'';
    el.dataset.truckingXp=truckingXP!==null?truckingXP:'';
    el.dataset.bonusXp=bonusXP!==null?bonusXP:'';
    el.dataset.jobName=jobName;
  }
</script>
</body>
</html>
